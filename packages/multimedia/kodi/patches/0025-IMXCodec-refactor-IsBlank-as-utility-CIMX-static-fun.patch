From dfe6f8f3a6f494d204d89ead77390a72257094cb Mon Sep 17 00:00:00 2001
From: Matus Kral <matuskral@me.com>
Date: Mon, 5 Sep 2016 04:57:23 +0200
Subject: [PATCH 25/37] [IMXCodec] refactor IsBlank() as utility(CIMX) static
 func

---
 xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecIMX.cpp | 7 ++-----
 xbmc/linux/imx/IMX.cpp                                      | 9 +++++++++
 xbmc/linux/imx/IMX.h                                        | 2 ++
 3 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecIMX.cpp b/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecIMX.cpp
index 02e829b..5d05b64 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecIMX.cpp
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecIMX.cpp
@@ -1447,14 +1447,11 @@ bool CIMXContext::Blank()
 
 void CIMXContext::Run()
 {
-  unsigned long curBlank = FB_BLANK_NORMAL;
-
   CSingleLock lk(m_pageSwapLock);
-  while (curBlank &&
-        !ioctl(open(FB_DEVICE, O_RDONLY, 0), MXCFB_GET_FB_BLANK, &curBlank))
+  while (CIMX::IsBlank())
     Sleep(10);
 
-  m_bFbIsConfigured = !curBlank;
+  m_bFbIsConfigured = true;
 }
 
 bool CIMXContext::Unblank()
diff --git a/xbmc/linux/imx/IMX.cpp b/xbmc/linux/imx/IMX.cpp
index ee4e60a..4087406 100644
--- a/xbmc/linux/imx/IMX.cpp
+++ b/xbmc/linux/imx/IMX.cpp
@@ -158,6 +158,15 @@ void CIMX::OnResetDisplay()
   m_change = true;
 }
 
+bool CIMX::IsBlank()
+{
+  unsigned long curBlank;
+  int fd = open(FB_DEVICE, O_RDONLY | O_NONBLOCK);
+  bool ret = ioctl(fd, MXCFB_GET_FB_BLANK, &curBlank) || curBlank != FB_BLANK_UNBLANK;
+  close(fd);
+  return ret;
+}
+
 bool CIMXFps::Recalc()
 {
   double prev = DVD_NOPTS_VALUE;
diff --git a/xbmc/linux/imx/IMX.h b/xbmc/linux/imx/IMX.h
index c0a13cd..8d13333 100644
--- a/xbmc/linux/imx/IMX.h
+++ b/xbmc/linux/imx/IMX.h
@@ -54,6 +54,8 @@ public:
   int           WaitVsync();
   virtual void  OnResetDisplay();
 
+  static bool   IsBlank();
+
 private:
   virtual void  Process();
   bool          UpdateDCIC();
-- 
1.9.1

